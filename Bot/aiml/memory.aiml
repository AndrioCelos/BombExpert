<?xml version="1.0" encoding="UTF-8"?>
<aiml>
	<category>
		<pattern>defuse memory</pattern>
		<template>
			<think>
				<set name='topic'>Bomb Memory</set>
				<srai>reset memory</srai>
			</think>
			<oob>SetGrammar memory</oob><oob>SetPartialInput false</oob>
			Read me the number on the display.
		</template>
	</category>
	<category>
		<pattern>resume memory</pattern>
		<template>
			<think><set name='topic'>Bomb Memory</set></think>
			<oob>SetGrammar memory</oob><oob>SetPartialInput false</oob>
			Stage <get name='BombMemoryStage'/>.
		</template>
	</category>
	<category>
		<pattern>reset memory</pattern>
		<template>
			<think>
				<set name='BombMemoryStage'>0</set>
				<set name='MemoryPos1'>unknown</set>
				<set name='MemoryPos2'>unknown</set>
				<set name='MemoryPos3'>unknown</set>
				<set name='MemoryPos4'>unknown</set>
				<set name='MemoryPos5'>unknown</set>
				<set name='MemoryLabel1'>unknown</set>
				<set name='MemoryLabel2'>unknown</set>
				<set name='MemoryLabel3'>unknown</set>
				<set name='MemoryLabel4'>unknown</set>
				<set name='MemoryLabel5'>unknown</set>
			</think>
			OK
		</template>
	</category>

	<topic name='Bomb Memory ^'>
		<category>
			<pattern><set>number</set></pattern>
			<template><srai>MemoryRead <explode><star/></explode></srai></template>
		</category>
		<category>
			<pattern><set>number</set> <set>number</set> <set>number</set> <set>number</set> <set>number</set></pattern>
			<template>MemoryRead <star index='1'/> <star index='2'/> <star index='3'/> <star index='4'/> <star index='5'/></template>
		</category>
		<category>
			<pattern>MemoryRead <set>number</set></pattern>
			<template>
				<condition name='BombMemoryStage'>
					<li value='5'>That should have been the last stage. Are we starting a new module?</li>
					<li>
						<think>
							<set name='BombMemoryStage'><map name='successor'><get name='BombMemoryStage'/></map></set>
							<set var='rule'><srai>GetRule <get name='BombMemoryStage'/> <star/></srai></set>
							<set var='ruleType'><srai>XFirst <get var='rule'/></srai></set>
							<set var='ruleParam'><srai>XRest <get var='rule'/></srai></set>
						</think>

						<condition var='ruleType'>
							<li value='Position'>
								Press the
								<map name='ordinal'><set><name>MemoryPos<get name='BombMemoryStage'/></name><get var='ruleParam'/></set></map>
								position.
							</li>
							<li value='Label'>
								Press the label
								<set><name>MemoryLabel<get name='BombMemoryStage'/></name><get var='ruleParam'/></set>.
							</li>
							<li value='SamePosition'>
								<think><set var='pos'><get><name>MemoryPos<get var='ruleParam'/></name></get></set></think>
								<condition var='pos'>
									<li value='unknown'>Press the position that you pressed in stage <get var='ruleParam'/>.</li>
									<li>
										Press the
										<map name='ordinal'><set><name>MemoryPos<get name='BombMemoryStage'/></name><get var='pos'/></set></map>
										position.
									</li>
								</condition>
							</li>
							<li value='SameLabel'>
								<think><set var='label'><get><name>MemoryLabel<get var='ruleParam'/></name></get></set></think>
								<condition var='label'>
									<li value='unknown'>Press the label that you pressed in stage <get var='ruleParam'/>.</li>
									<li>
										Press the label
										<set><name>MemoryLabel<get name='BombMemoryStage'/></name><get var='label'/></set>.
									</li>
								</condition>
							</li>
						</condition>
					</li>
				</condition>
			</template>
		</category>
		<category>
			<pattern>MemoryRead <set>number</set> <set>number</set> <set>number</set> <set>number</set> <set>number</set></pattern>
			<template>
				<condition name='BombMemoryStage'>
					<li value='5'>That should have been the last stage. Are we starting a new module?</li>
					<li>
						<think>
							<set name='BombMemoryStage'><map name='successor'><get name='BombMemoryStage'/></map></set>
							<set var='rule'><srai>GetRule <get name='BombMemoryStage'/> <star/></srai></set>
							<set var='ruleType'><srai>XFirst <get var='rule'/></srai></set>
							<set var='ruleParam'><srai>XRest <get var='rule'/></srai></set>

							<condition var='ruleType'>
								<li value='Position'><set var='pos'><get var='ruleParam'/></set></li>
								<li value='Label'><set var='pos'><srai>XIndex <get var='ruleParam'/> <star index='2'/> <star index='3'/> <star index='4'/> <star index='5'/></srai></set></li>
								<li value='SamePosition'><set var='pos'><get><name>MemoryPos<get var='ruleParam'/></name></get></set></li>
								<li value='SameLabel'><set var='pos'><srai>XIndex <get><name>MemoryLabel<get var='ruleParam'/></name></get> <star index='2'/> <star index='3'/> <star index='4'/> <star index='5'/></srai></set></li>
							</condition>

							<set var='label'><star><index><map name='successor'><get var='pos'/></map></index></star></set>
							<set><name>MemoryPos<get name='BombMemoryStage'/></name><get var='pos'/></set>
							<set><name>MemoryLabel<get name='BombMemoryStage'/></name><get var='label'/></set>
						</think>
						Press <get var='label'/>.
					</li>
				</condition>
			</template>
		</category>

		<category>
			<pattern>next set</pattern>
			<template><srai>reset memory</srai></template>
		</category>
		<category>
			<pattern>next memory</pattern>
			<template><srai>next set</srai></template>
		</category>
		<category>
			<pattern>next module</pattern>
			<template><srai>next set</srai></template>
		</category>
		<category>
			<pattern>new set</pattern>
			<template><think><set name='BombMemoryStage'>1</set></think></template>
		</category>
		<category>
			<pattern>new memory</pattern>
			<template><srai>next set</srai></template>
		</category>
		<category>
			<pattern>new module</pattern>
			<template><srai>next set</srai></template>
		</category>

		<category>
			<pattern>yes</pattern>
			<that>Are we starting a new module</that>
			<template><srai>reset memory</srai></template>
		</category>
		<category>
			<pattern>no</pattern>
			<that>Are we starting a new module</that>
			<template>I have lost track. What stage number are we on?</template>
		</category>

		<category>
			<pattern><set>number</set></pattern>
			<that>What stage number are we on</that>
			<template>
				<think><set name='BombMemoryStage'><map name='predecessor'><star/></map></set></think>
				OK. Read the number on the display.
			</template>
		</category>
		<category>
			<pattern>stage <set>number</set></pattern>
			<that>What stage number are we on</that>
			<template><sr/></template>
		</category>

		<category>
			<pattern>position <set>number</set></pattern>
			<template>
				<think><set><name>MemoryPos<get name='BombMemoryStage'/></name><star/></set></think>
				OK.
			</template>
		</category>
		<category>
			<pattern><set>ordinal</set> position</pattern>
			<template><srai>position <map name='OrdinalToNumber'><star/></map></srai></template>
		</category>
		<category>
			<pattern>label <set>number</set></pattern>
			<template>
				<think><set><name>MemoryLabel<get name='BombMemoryStage'/></name><star/></set></think>
				OK.
			</template>
		</category>
		<category>
			<pattern>* was *</pattern>
			<template><srai><star/> <star index='2'/></srai></template>
		</category>
		<category>
			<pattern>* is *</pattern>
			<template><srai><star/> <star index='2'/></srai></template>
		</category>
		<category>
			<pattern>the * was *</pattern>
			<template><srai><star/> <star index='2'/></srai></template>
		</category>
		<category>
			<pattern>the * is *</pattern>
			<template><srai><star/> <star index='2'/></srai></template>
		</category>

		<!-- Usage: GetRule [stage] [display] -->
		<!-- Returns one of the following rule types, along with a number: -->
		<!-- Position [n], Label [n], SamePosition [stage], SameLabel [stage] -->
		<category>
			<pattern>GetRule *</pattern>
			<template>
				<condition name='SraixUnavailable'>
					<li value='true'><srai>GetRuleFallback <star/></srai></li>
					<li><sraix service='BombExpert.Solvers.MemorySolver'>GetRule <get name='RuleSeed'/> <star/></sraix></li>
				</condition>
			</template>
		</category>
		<category>
			<pattern>GetRuleFallback * *</pattern>
			<template>
				<think>
					<set var='stage'><star/></set>
					<set var='display'><star index='2'/></set>
				</think>
				<condition var='stage'>
					<li value='1'>
						<condition var='display'>
							<li value='1'>Position 2</li>
							<li value='2'>Position 2</li>
							<li value='3'>Position 3</li>
							<li value='4'>Position 4</li>
						</condition>
					</li>
					<li value='2'>
						<condition var='display'>
							<li value='1'>Label 4</li>
							<li value='2'>SamePosition 1</li>
							<li value='3'>Position 1</li>
							<li value='4'>SamePosition 1</li>
						</condition>
					</li>
					<li value='3'>
						<condition var='display'>
							<li value='1'>SameLabel 2</li>
							<li value='2'>SameLabel 1</li>
							<li value='3'>Position 3</li>
							<li value='4'>Label 4</li>
						</condition>
					</li>
					<li value='4'>
						<condition var='display'>
							<li value='1'>SamePosition 1</li>
							<li value='2'>Position 1</li>
							<li value='3'>SamePosition 2</li>
							<li value='4'>SamePosition 2</li>
						</condition>
					</li>
					<li value='5'>
						<condition var='display'>
							<li value='1'>SameLabel 1</li>
							<li value='2'>SameLabel 2</li>
							<li value='3'>SameLabel 4</li>
							<li value='4'>SameLabel 3</li>
						</condition>
					</li>
				</condition>
			</template>
		</category>
	</topic>
</aiml>
