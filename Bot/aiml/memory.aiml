<?xml version="1.0" encoding="UTF-8"?>
<aiml>
	<category>
		<pattern>resume memory</pattern>
		<template>
			<srai>DeselectModule</srai>
			<think><set name='topic'>Bomb Memory</set></think>
			Stage <get name='BombMemoryStage'/>.
		</template>
	</category>

	<topic name='Bomb Memory ^'>
		<category>
			<pattern>SelectModule</pattern>
			<template>Read me the number on the display.</template>
		</category>

		<category>
			<pattern>InitModule</pattern>
			<template>
				<think>
					<set name='BombMemoryStage'>0</set>
					<set name='MemoryPos1'>unknown</set>
					<set name='MemoryPos2'>unknown</set>
					<set name='MemoryPos3'>unknown</set>
					<set name='MemoryPos4'>unknown</set>
					<set name='MemoryPos5'>unknown</set>
					<set name='MemoryLabel1'>unknown</set>
					<set name='MemoryLabel2'>unknown</set>
					<set name='MemoryLabel3'>unknown</set>
					<set name='MemoryLabel4'>unknown</set>
					<set name='MemoryLabel5'>unknown</set>
				</think>
			</template>
		</category>

		<category>
			<pattern><set>number</set></pattern>
			<template><srai>MemoryRead <explode><star/></explode></srai></template>
		</category>
		<category>
			<pattern><set>number</set> <set>number</set> <set>number</set> <set>number</set> <set>number</set></pattern>
			<template><srai>MemoryRead <star index='1'/> <star index='2'/> <star index='3'/> <star index='4'/> <star index='5'/></srai></template>
		</category>
		<category>
			<pattern>MemoryRead <set>number</set></pattern>
			<template>
				<condition name='BombMemoryStage'>
					<li value='5'>That should have been the last stage. Are we starting a new module?</li>
					<li>
						<think>
							<set name='BombMemoryStage'><map name='successor'><get name='BombMemoryStage'/></map></set>
							<srai>SouvenirPut Display <get name='BombMemoryStage'/> XS <star/></srai>
							<set var='rule'><srai>Solver Memory GetRule <get name='BombMemoryStage'/> <star/></srai></set>
							<set var='ruleType'><srai>XFirst <get var='rule'/></srai></set>
							<set var='ruleParam'><srai>XRest <get var='rule'/></srai></set>
						</think>

						<condition var='ruleType'>
							<li value='Position'>
								Press the
								<map name='ordinal'><srai>SouvenirPut Position <get name='BombMemoryStage'/> XS
									<set><name>MemoryPos<get name='BombMemoryStage'/></name><get var='ruleParam'/></set>
								</srai></map>
								position.
							</li>
							<li value='Label'>
								Press the label
								<srai>SouvenirPut Label <get name='BombMemoryStage'/> XS
									<set><name>MemoryLabel<get name='BombMemoryStage'/></name><get var='ruleParam'/></set>
								</srai>.
							</li>
							<li value='SamePosition'>
								<think><set var='pos'><get><name>MemoryPos<get var='ruleParam'/></name></get></set></think>
								<condition var='pos'>
									<li value='unknown'>Press the position that you pressed in stage <get var='ruleParam'/>.</li>
									<li>
										Press the
										<map name='ordinal'><srai>SouvenirPut Position <get name='BombMemoryStage'/> XS
											<set><name>MemoryPos<get name='BombMemoryStage'/></name><get var='pos'/></set>
										</srai></map>
										position.
									</li>
								</condition>
							</li>
							<li value='SameLabel'>
								<think><set var='label'><get><name>MemoryLabel<get var='ruleParam'/></name></get></set></think>
								<condition var='label'>
									<li value='unknown'>Press the label that you pressed in stage <get var='ruleParam'/>.</li>
									<li>
										Press the label
										<srai>SouvenirPut Label <get name='BombMemoryStage'/> XS
											<set><name>MemoryLabel<get name='BombMemoryStage'/></name><get var='label'/></set>
										</srai>.
									</li>
								</condition>
							</li>
						</condition>
					</li>
				</condition>
			</template>
		</category>
		<category>
			<pattern>MemoryRead <set>number</set> <set>number</set> <set>number</set> <set>number</set> <set>number</set></pattern>
			<template>
				<condition name='BombMemoryStage'>
					<li value='5'>That should have been the last stage. Are we starting a new module?</li>
					<li>
						<think>
							<set name='BombMemoryStage'><map name='successor'><get name='BombMemoryStage'/></map></set>
							<srai>SouvenirPut Display <get name='BombMemoryStage'/> XS <star/></srai>
							<set var='rule'><srai>Solver Memory GetRule <get name='BombMemoryStage'/> <star/></srai></set>
							<set var='ruleType'><srai>XFirst <get var='rule'/></srai></set>
							<set var='ruleParam'><srai>XRest <get var='rule'/></srai></set>

							<condition var='ruleType'>
								<li value='Position'><set var='pos'><get var='ruleParam'/></set></li>
								<li value='Label'><set var='pos'><srai>XIndex <get var='ruleParam'/> XS <star index='2'/> <star index='3'/> <star index='4'/> <star index='5'/></srai></set></li>
								<li value='SamePosition'><set var='pos'><get><name>MemoryPos<get var='ruleParam'/></name></get></set></li>
								<li value='SameLabel'><set var='pos'><srai>XIndex <get><name>MemoryLabel<get var='ruleParam'/></name></get> XS <star index='2'/> <star index='3'/> <star index='4'/> <star index='5'/></srai></set></li>
							</condition>

							<set var='label'><star><index><map name='successor'><get var='pos'/></map></index></star></set>
							<srai>SouvenirPut Position <get name='BombMemoryStage'/> XS <set><name>MemoryPos<get name='BombMemoryStage'/></name><get var='pos'/></set></srai>
							<srai>SouvenirPut Label <get name='BombMemoryStage'/> XS <set><name>MemoryLabel<get name='BombMemoryStage'/></name><get var='label'/></set></srai>
						</think>
						Press <get var='label'/>.
					</li>
				</condition>
			</template>
		</category>

		<category>
			<pattern>yes</pattern>
			<that>Are we starting a new module</that>
			<template><srai>next set</srai></template>
		</category>
		<category>
			<pattern>no</pattern>
			<that>Are we starting a new module</that>
			<template>I have lost track. What stage number are we on?</template>
		</category>

		<category>
			<pattern><set>number</set></pattern>
			<that>What stage number are we on</that>
			<template>
				<think><set name='BombMemoryStage'><map name='predecessor'><star/></map></set></think>
				OK. Read the number on the display.
			</template>
		</category>
		<category>
			<pattern>stage <set>number</set></pattern>
			<that>What stage number are we on</that>
			<template><sr/></template>
		</category>

		<category>
			<pattern>position <set>number</set></pattern>
			<template>
				<think>
					<srai>SouvenirPut Position <get name='BombMemoryStage'/> XS
						<set><name>MemoryPos<get name='BombMemoryStage'/></name><star/></set>
					</srai>
				</think>
				OK.
			</template>
		</category>
		<category>
			<pattern><set>ordinal</set> position</pattern>
			<template><srai>position <map name='OrdinalToNumber'><star/></map></srai></template>
		</category>
		<category>
			<pattern>label <set>number</set></pattern>
			<template>
				<think>
					<srai>SouvenirPut Label <get name='BombMemoryStage'/> XS
						<set><name>MemoryLabel<get name='BombMemoryStage'/></name><star/></set>
					</srai>
				</think>
				OK.
			</template>
		</category>
		<category>
			<pattern>* was *</pattern>
			<template><srai><star/> <star index='2'/></srai></template>
		</category>
		<category>
			<pattern>* is *</pattern>
			<template><srai><star/> <star index='2'/></srai></template>
		</category>
		<category>
			<pattern>the * was *</pattern>
			<template><srai><star/> <star index='2'/></srai></template>
		</category>
		<category>
			<pattern>the * is *</pattern>
			<template><srai><star/> <star index='2'/></srai></template>
		</category>

		<!-- Usage: Solver Memory GetRule [stage] [display] -->
		<!-- Returns one of the following rule types, along with a number: -->
		<!-- Position [n], Label [n], SamePosition [stage], SameLabel [stage] -->
		<category>
			<pattern>SolverFallback Memory <set>number</set> GetRule *</pattern>
			<template>
				<think><set var='test'><map><name>Memory<star/></name>1 1</map></set></think>
				<condition var='test'>
					<li value='unknown'>NoSolver</li>
					<li><map><name>Memory<star/></name><star index='2'/></map></li>
				</condition>
			</template>
		</category>
	</topic>

	<category>
		<pattern>SouvenirInput Memory XS <set>number</set></pattern>
		<template>
			Displays were <srai>SouvenirGet Memory XS <star/> XS Display 1</srai>,
				<srai>SouvenirGet Memory XS <star/> XS Display 2</srai>,
				<srai>SouvenirGet Memory XS <star/> XS Display 3</srai>,
				<srai>SouvenirGet Memory XS <star/> XS Display 4</srai>,
				<srai>SouvenirGet Memory XS <star/> XS Display 5</srai>.
			Positions were <srai>SouvenirGet Memory XS <star/> XS Position 1</srai>,
				<srai>SouvenirGet Memory XS <star/> XS Position 2</srai>,
				<srai>SouvenirGet Memory XS <star/> XS Position 3</srai>,
				<srai>SouvenirGet Memory XS <star/> XS Position 4</srai>,
				<srai>SouvenirGet Memory XS <star/> XS Position 5</srai>.
			Labels were <srai>SouvenirGet Memory XS <star/> XS Label 1</srai>,
				<srai>SouvenirGet Memory XS <star/> XS Label 2</srai>,
				<srai>SouvenirGet Memory XS <star/> XS Label 3</srai>,
				<srai>SouvenirGet Memory XS <star/> XS Label 4</srai>,
				<srai>SouvenirGet Memory XS <star/> XS Label 5</srai>.
		</template>
	</category>
	<category>
		<pattern>SouvenirInput Memory XS <set>number</set> XS display <set>number</set></pattern>
		<template><srai>SouvenirGet Memory XS <star/> XS display <star index='2'/></srai></template>
	</category>
	<category>
		<pattern>SouvenirInput Memory XS <set>number</set> XS position <set>number</set></pattern>
		<template><srai>SouvenirGet Memory XS <star/> XS position <star index='2'/></srai></template>
	</category>
	<category>
		<pattern>SouvenirInput Memory XS <set>number</set> XS label <set>number</set></pattern>
		<template><srai>SouvenirGet Memory XS <star/> XS label <star index='2'/></srai></template>
	</category>
</aiml>
